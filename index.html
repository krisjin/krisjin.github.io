

<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>krisjin博客</title>
  <meta name="author" content="krisjin">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="krisjin博客"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="krisjin博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//libs.baidu.com/jquery/1.8.0/jquery.min.js"></script>
</head>


<body>
  <header id="header" class="inner">
<div class="alignleft">
  <h1><a href="/">krisjin博客</a></h1>
  <h2><a href="/">一步一脚印</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/about">关于</a></li>
    
	<!--<li> <a href="/atom.xml">RSS</a> </li>-->
<li> <a title="把这个链接拖到你的Chrome收藏夹工具栏中" href='javascript:(function() {
	function c() {
		var e = document.createElement("link");
		e.setAttribute("type", "text/css");
		e.setAttribute("rel", "stylesheet");
		e.setAttribute("href", f);
		e.setAttribute("class", l);
		document.body.appendChild(e)
	}
 
	function h() {
		var e = document.getElementsByClassName(l);
		for (var t = 0; t < e.length; t++) {
			document.body.removeChild(e[t])
		}
	}
 
	function p() {
		var e = document.createElement("div");
		e.setAttribute("class", a);
		document.body.appendChild(e);
		setTimeout(function() {
			document.body.removeChild(e)
		}, 100)
	}
 
	function d(e) {
		return {
			height : e.offsetHeight,
			width : e.offsetWidth
		}
	}
 
	function v(i) {
		var s = d(i);
		return s.height > e && s.height < n && s.width > t && s.width < r
	}
 
	function m(e) {
		var t = e;
		var n = 0;
		while (!!t) {
			n += t.offsetTop;
			t = t.offsetParent
		}
		return n
	}
 
	function g() {
		var e = document.documentElement;
		if (!!window.innerWidth) {
			return window.innerHeight
		} else if (e && !isNaN(e.clientHeight)) {
			return e.clientHeight
		}
		return 0
	}
 
	function y() {
		if (window.pageYOffset) {
			return window.pageYOffset
		}
		return Math.max(document.documentElement.scrollTop, document.body.scrollTop)
	}
 
	function E(e) {
		var t = m(e);
		return t >= w && t <= b + w
	}
 
	function S() {
		var e = document.createElement("audio");
		e.setAttribute("class", l);
		e.src = i;
		e.loop = false;
		e.addEventListener("canplay", function() {
			setTimeout(function() {
				x(k)
			}, 500);
			setTimeout(function() {
				N();
				p();
				for (var e = 0; e < O.length; e++) {
					T(O[e])
				}
			}, 15500)
		}, true);
		e.addEventListener("ended", function() {
			N();
			h()
		}, true);
		e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
		document.body.appendChild(e);
		e.play()
	}
 
	function x(e) {
		e.className += " " + s + " " + o
	}
 
	function T(e) {
		e.className += " " + s + " " + u[Math.floor(Math.random() * u.length)]
	}
 
	function N() {
		var e = document.getElementsByClassName(s);
		var t = new RegExp("\\b" + s + "\\b");
		for (var n = 0; n < e.length; ) {
			e[n].className = e[n].className.replace(t, "")
		}
	}
 
	var e = 30;
	var t = 30;
	var n = 350;
	var r = 350;
	var i = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake.mp3";
	var s = "mw-harlem_shake_me";
	var o = "im_first";
	var u = ["im_drunk", "im_baked", "im_trippin", "im_blown"];
	var a = "mw-strobe_light";
	var f = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css";
	var l = "mw_added_css";
	var b = g();
	var w = y();
	var C = document.getElementsByTagName("*");
	var k = null;
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (v(A)) {
			if (E(A)) {
				k = A;
				break
			}
		}
	}
	if (A === null) {
		console.warn("Could not find a node of the right size. Please try a different page.");
		return
	}
	c();
	S();
	var O = [];
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (v(A)) {
			O.push(A)
		}
	}
})()    '>High一下</a> </li>

  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-13T16:25:46.078Z"><a href="/2015/02/14/netty-file-server/">2月 14 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/14/netty-file-server/"></a></h1>
  

    </header>
    <div class="entry">
      
        <p>title: netty实现http文件服务器<br>date: 2015-02-14 00:07:01<br>categories: netty</p>
<h2 id="tags:_[netty]">tags: [netty]</h2>
<h3 id="Http介绍">Http介绍</h3>
<p>Http(超文本传输协议)协议是建立在TCP传输协议之上的应用成协议,Http由于便捷、快速的方式，适用于分布式超媒体信息系统。Http是目前Web开发的主流协议，基于Http的应用非常广泛，因此掌握HTTP的开发非常重要。由于netty的HTTP协议栈是基于netty的NIO通信框架开发的，所以netty的HTTP协议也是异步非阻塞的。<br>&lt;!—more—&gt;<br>具体的关于HTTP及Netyy的实现细节在以后的章节在写，先上实例代码：</p>
<h3 id="实例代码">实例代码</h3>
<p><strong>服务端：</strong></p>
<pre><code><span class="xml"><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-class"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>class<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>HttpFileServer<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>run<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>final<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>int<span class="tag">&lt;/<span class="title">span</span>&gt;</span> port, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>final<span class="tag">&lt;/<span class="title">span</span>&gt;</span> String url)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> InterruptedException <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

    EventLoopGroup bossGroup = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> NioEventLoopGroup();
    EventLoopGroup workerGroup = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> NioEventLoopGroup();

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>try<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
        ServerBootstrap boot = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> ServerBootstrap();

        boot.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)
                .childHandler(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> ChannelInitializer<span class="tag">&lt;<span class="title">SocketChannel</span>&gt;</span>() {

                    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-annotation"</span>&gt;</span>@Override<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
                    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>protected<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>initChannel<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(SocketChannel ch)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"http-decoder"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> HttpRequestDecoder());
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"http-aggregator"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> HttpObjectAggregator(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>65536<span class="tag">&lt;/<span class="title">span</span>&gt;</span>));
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"http-encoder"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> HttpResponseEncoder());
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"http-chunked"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> ChunkedWriteHandler());
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"fileServerHandler"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> HttpFileServerHandler(url));
                    }

                });
        ChannelFuture cf =boot.bind(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"127.0.0.1"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>,port).sync();
        System.out.println(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"Http文件目录服务器启动：http://127.0.0.1:"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>+port+url);
        cf.channel().closeFuture().sync();

    } <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>finally<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
        bossGroup.shutdownGracefully();
        workerGroup.shutdownGracefully();

    }

}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>static<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>main<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(String[] args)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> InterruptedException <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
    String url=<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"/src/main/java/"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> HttpFileServer().run(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>8080<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, url);

}

}
`<span class="tag">&lt;/<span class="title">pre</span>&gt;</span>

**服务端handler:**

<span class="tag">&lt;<span class="title">pre</span>&gt;</span>`<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>class<span class="tag">&lt;/<span class="title">span</span>&gt;</span> HttpFileServerHandler <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>extends<span class="tag">&lt;/<span class="title">span</span>&gt;</span> SimpleChannelInboundHandler<span class="tag">&lt;<span class="title">FullHttpRequest</span>&gt;</span> {

HttpMethod GET = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> HttpMethod(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"GET"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>private<span class="tag">&lt;/<span class="title">span</span>&gt;</span> String url;

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>private<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>final<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Pattern ALLOWED_FILE_NAME = Pattern.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>compile<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"[A-Za-z0-9][-_A-Za-z0-9\\.]*"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>private<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>final<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Pattern INSECURE_URI = Pattern.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>compile<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>".*[<span class="tag">&lt;&gt;</span>&amp;\"].*"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> HttpFileServerHandler(String url) {
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>this<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.url = url;
}

@Override
<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>protected<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> messageReceived(ChannelHandlerContext ctx, FullHttpRequest request) <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception {

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (!request.getDecoderResult().isSuccess()) {
        sendError(ctx, HttpResponseStatus.BAD_REQUEST);
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    }

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (request.getMethod() != HttpMethod.GET) {
        sendError(ctx, HttpResponseStatus.METHOD_NOT_ALLOWED);
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    }
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>final<span class="tag">&lt;/<span class="title">span</span>&gt;</span> String uri = request.getUri();
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>final<span class="tag">&lt;/<span class="title">span</span>&gt;</span> String path = sanitizeUri(uri);
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (path == <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>null<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) {
        sendError(ctx, HttpResponseStatus.FORBIDDEN);
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    }

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>File<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span> = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>File<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(path);

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.isHidden() || !<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.exists()) {
        sendError(ctx, HttpResponseStatus.NOT_FOUND);
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    }

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.isDirectory()) {
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (uri.endsWith(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"/"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>)) {
            sendList(ctx, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
        } <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>else<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
            sendRedirect(ctx, uri + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>'/'<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
        }
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    }

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (!<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.isFile()) {
        sendError(ctx, HttpResponseStatus.FORBIDDEN);
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    }

    RandomAccessFile randomAccessFile = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>null<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>try<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
        randomAccessFile = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> RandomAccessFile(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"r"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    } <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>catch<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (FileNotFoundException e) {
        sendError(ctx, HttpResponseStatus.NO_CONTENT);
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    }
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>long<span class="tag">&lt;/<span class="title">span</span>&gt;</span> fileLength = randomAccessFile.length();
    HttpResponse response = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> DefaultHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);
    HttpHeaders.setContentLength(response, fileLength);
    setContentTypeHeader(response, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (HttpHeaders.isKeepAlive(request)) {
        response.headers().set(HttpHeaders.Names.CONNECTION, HttpHeaders.Values.KEEP_ALIVE);
    }
    ctx.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>write<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(response);
    ChannelFuture sendFileFuture;

    sendFileFuture = ctx.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>write<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> ChunkedFile(randomAccessFile, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, fileLength, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>8192<span class="tag">&lt;/<span class="title">span</span>&gt;</span>), ctx.newProgressivePromise());
    sendFileFuture.addListener(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> ChannelProgressiveFutureListener() {

        @Override
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> operationComplete(ChannelProgressiveFuture future) <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception {

            System.err.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>println<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(future.channel() + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>" transfer complete"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);

        }

        @Override
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> operationProgressed(ChannelProgressiveFuture future, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>long<span class="tag">&lt;/<span class="title">span</span>&gt;</span> progress, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>long<span class="tag">&lt;/<span class="title">span</span>&gt;</span> total)
                <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception {
            <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (total <span class="tag">&lt; &lt;<span class="attribute">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) {
                System.err.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>println<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(future.channel() + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>" transfer progress : "<span class="tag">&lt;/<span class="title">span</span>&gt;</span> + progress);
            } <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>else<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
                System.err.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>println<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(future.channel() + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>" transfer progress : "<span class="tag">&lt;/<span class="title">span</span>&gt;</span> + progress + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>" / "<span class="tag">&lt;/<span class="title">span</span>&gt;</span> + total);
            }
        }
    });

    ChannelFuture lastContentFuture = ctx.writeAndFlush(LastHttpContent.EMPTY_LAST_CONTENT);
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (!HttpHeaders.isKeepAlive(request)) {
        lastContentFuture.addListener(ChannelFutureListener.CLOSE);
    }

}

@Override
<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> exceptionCaught(ChannelHandlerContext ctx, Throwable cause) <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception {

    cause.printStackTrace();
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (ctx.channel().isActive()) {
        sendError(ctx, HttpResponseStatus.INTERNAL_SERVER_ERROR);
    }
}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>private<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> sendError(ChannelHandlerContext ctx, HttpResponseStatus status) {
    FullHttpResponse response = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, status, Unpooled.copiedBuffer(
            <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"Failure :"<span class="tag">&lt;/<span class="title">span</span>&gt;</span> + status + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"\r\n"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, CharsetUtil.UTF_8));
    response.headers().set(HttpHeaders.Names.CONTENT_TYPE, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"text/plain; charset=UTF-8"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);
}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> String sanitizeUri(String uri) {

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// Decode the path.<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>try<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
        uri = URLDecoder.decode(uri, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"UTF-8"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    } <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>catch<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (UnsupportedEncodingException e) {
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throw<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Error(e);
    }

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (uri.isEmpty() || uri.charAt(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) != <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>'/'<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) {
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>null<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    }

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// Convert file separators.<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
    uri = uri.replace(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>'/'<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>File<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.separatorChar);

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// Simplistic dumb security check.<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// You will have to do something serious in the production environment.<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (uri.contains(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>File<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.separator + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>'.'<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) || uri.contains(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>'.'<span class="tag">&lt;/<span class="title">span</span>&gt;</span> + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>File<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.separator) || uri.charAt(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) == <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>'.'<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
            || uri.charAt(uri.length() - <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>1<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) == <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>'.'<span class="tag">&lt;/<span class="title">span</span>&gt;</span> || INSECURE_URI.matcher(uri).matches()) {
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>null<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    }

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// Convert to absolute path.<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>return<span class="tag">&lt;/<span class="title">span</span>&gt;</span> System.getProperty(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"user.dir"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>File<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.separator + uri;
}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>final<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> sendList(ChannelHandlerContext ctx, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>File<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) {
    FullHttpResponse response = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);
    response.headers().set(HttpHeaders.Names.CONTENT_TYPE, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"text/html; charset=UTF-8"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    StringBuilder sb = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> StringBuilder();

    String dirPath = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.getPath();

    sb.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"<span class="doctype">&lt;!DOCTYPE html&gt;</span>\r\n"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    sb.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"<span class="tag">&lt;<span class="title">html</span>&gt;</span><span class="tag">&lt;<span class="title">head</span>&gt;</span><span class="tag">&lt;<span class="title">title</span>&gt;</span>"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    sb.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(dirPath);
    sb.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"目录："<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    sb.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"<span class="tag">&lt;/<span class="title">title</span>&gt;</span><span class="tag">&lt;/<span class="title">head</span>&gt;</span><span class="tag">&lt;<span class="title">body</span>&gt;</span>\r\n"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    sb.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"<span class="tag">&lt;<span class="title">h3</span>&gt;</span>"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    sb.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(dirPath).<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"目录："<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);
    sb.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"<span class="tag">&lt;/<span class="title">h3</span>&gt;</span>\r\n"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);

    sb.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"</span>
</code></pre><p>“);<br>        sb.<span class="hljs-keyword">append</span>(<span class="hljs-string">“<em>   <a href="\"../\"">..</a><br>\r\n”</em></span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">File</span> f : <span class="hljs-keyword">file</span>.listFiles()) {<br>            <span class="hljs-keyword">if</span> (f.isHidden() || !f.canRead()) {<br>                <span class="hljs-keyword">continue</span>;<br>            }<br>            String name = f.getName();<br>            <span class="hljs-keyword">if</span> (!ALLOWED_FILE_NAME.matcher(name).matches()) {<br>                <span class="hljs-keyword">continue</span>;<br>            }<br>            sb.<span class="hljs-keyword">append</span>(<span class="hljs-string">“   <a href="\""</span">);<br>            sb.<span class="hljs-keyword">append</span>(name);<br>            sb.<span class="hljs-keyword">append</span>(<span class="hljs-string">“\”&gt;”</span>);<br>            sb.<span class="hljs-keyword">append</span>(name);<br>            sb.<span class="hljs-keyword">append</span>(<span class="hljs-string">“</span></a>\r\n”</span>);</p>
<pre><code>    ByteBuf buffer = Unpooled.copiedBuffer(sb, CharsetUtil.UTF_8);
    response.content().writeBytes(buffer);
    buffer.release();

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// Close the connection as soon as the error message is sent.<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
    ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);
}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> sendRedirect(ChannelHandlerContext ctx, String newUri) {
    FullHttpResponse response = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.FOUND);
    response.headers().set(HttpHeaders.Names.LOCATION, newUri);
    ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);

}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>private<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> setContentTypeHeader(HttpResponse response, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>File<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) {

    MimetypesFileTypeMap mimeTypeMap = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> MimetypesFileTypeMap();
    response.headers().set(HttpHeaders.Names.CONTENT_TYPE, mimeTypeMap.getContentType(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>file<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.getPath()));
}

}
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-13T16:07:45.625Z"><a href="/2015/02/14/netty-delimiter-decoder/">2月 14 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/14/netty-delimiter-decoder/"></a></h1>
  

    </header>
    <div class="entry">
      
        <p>title: netty分隔符解码<br>date: 2015-02-11 10:17:35<br>categories: netty</p>
<h2 id="tags:_[netty]">tags: [netty]</h2>
<h3 id="DelimiterBasedFrameDecoder分隔符解码">DelimiterBasedFrameDecoder分隔符解码</h3>
<p>上一章介绍了换行的粘包拆包处理，使用到的类是LineBasedFrameDecoder和StringDecoder<br>这章介绍分隔符解码的处理。</p>
<p>&lt;!—more—&gt;</p>
<p><strong>服务端代码</strong></p>
<pre><code><span class="xml"><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-class"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>class<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>EchoServer<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>bind<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>int<span class="tag">&lt;/<span class="title">span</span>&gt;</span> port)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// 配置服务端线程组<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
    EventLoopGroup bossGroup = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> NioEventLoopGroup();
    EventLoopGroup workerGroup = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> NioEventLoopGroup();

    ServerBootstrap boot = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> ServerBootstrap();
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>try<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
        boot.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)
                .option(ChannelOption.SO_BACKLOG, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>100<span class="tag">&lt;/<span class="title">span</span>&gt;</span>).handler(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> LoggingHandler(LogLevel.INFO))
                .childHandler(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> ChannelInitializer<span class="tag">&lt;<span class="title">SocketChannel</span>&gt;</span>() {

                    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-annotation"</span>&gt;</span>@Override<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
                    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>protected<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>initChannel<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(SocketChannel ch)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

                        ByteBuf delimiter = Unpooled.copiedBuffer(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"$_"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.getBytes());
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> DelimiterBasedFrameDecoder(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>1024<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, delimiter));
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> StringDecoder());
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> EchoServerHandler());
                    }

                });

        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// 绑定端口，同步等待成功<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
        ChannelFuture cf = boot.bind(port).sync();
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// 等待服务器端监听端口关闭<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
        cf.channel().closeFuture().sync();
    } <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>finally<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// 优雅退出，释放线程池资源<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
        bossGroup.shutdownGracefully();
        workerGroup.shutdownGracefully();
    }
}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>static<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>main<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(String[] args)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>int<span class="tag">&lt;/<span class="title">span</span>&gt;</span> port = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>8080<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>if<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (args.length &gt; <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">span</span>&gt;</span>) {
        port = Integer.valueOf(args[<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">span</span>&gt;</span>]);
    }

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> EchoServer().bind(port);
}
}
`<span class="tag">&lt;/<span class="title">pre</span>&gt;</span>

**服务端handler**

<span class="tag">&lt;<span class="title">pre</span>&gt;</span>`<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-class"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>class<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>EchoServerHandler<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>extends<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>ChannelHandlerAdapter<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>int<span class="tag">&lt;/<span class="title">span</span>&gt;</span> counter = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>channelRead<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(ChannelHandlerContext ctx, Object msg)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
    String body = (String) msg;
    System.out.println(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"This is "<span class="tag">&lt;/<span class="title">span</span>&gt;</span> + ++counter + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>" times receive client : ["<span class="tag">&lt;/<span class="title">span</span>&gt;</span> + body + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"]"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);

    body += <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"$_"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    ByteBuf echo =Unpooled.copiedBuffer(body.getBytes());

    ctx.writeAndFlush(echo);

}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>exceptionCaught<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(ChannelHandlerContext ctx, Throwable cause)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
    cause.printStackTrace();
    ctx.close();
}
}
`<span class="tag">&lt;/<span class="title">pre</span>&gt;</span>

**客户端代码**

<span class="tag">&lt;<span class="title">pre</span>&gt;</span>`<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>class<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>EchoClient<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>connect<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>int<span class="tag">&lt;/<span class="title">span</span>&gt;</span> port, String host)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> throws Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

    EventLoopGroup <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>group<span class="tag">&lt;/<span class="title">span</span>&gt;</span> = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> NioEventLoopGroup();

    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>try<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
        Bootstrap boot = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Bootstrap();
        boot.<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>group<span class="tag">&lt;/<span class="title">span</span>&gt;</span>(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>group<span class="tag">&lt;/<span class="title">span</span>&gt;</span>).channel(NioSocketChannel.class).option(ChannelOption.TCP_NODELAY, <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">span</span>&gt;</span>)
                .handler(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> ChannelInitializer<span class="tag">&lt;<span class="title">SocketChannel</span>&gt;</span>() {

                    @<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span>Override
                    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>protected<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>initChannel<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(SocketChannel ch)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> throws Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

                        ByteBuf delimiter = Unpooled.copiedBuffer(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"$_"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.getBytes());
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> DelimiterBasedFrameDecoder(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>1024<span class="tag">&lt;/<span class="title">span</span>&gt;</span>, delimiter));
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> StringDecoder());
                        ch.pipeline().addLast(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> EchoClientHandler());

                    }

                });

        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// 发起异步连接操作<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
        ChannelFuture cf = boot.connect(host, port).sync();
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// 等待客户端链路关闭<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
        cf.channel().closeFuture().sync();

    } <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>finally<span class="tag">&lt;/<span class="title">span</span>&gt;</span> {
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-comment"</span>&gt;</span>// 优雅退出，释放NIO线程组<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
        <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>group<span class="tag">&lt;/<span class="title">span</span>&gt;</span>.shutdownGracefully();
    }

}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>static<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>main<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(String[] args)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> throws Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>int<span class="tag">&lt;/<span class="title">span</span>&gt;</span> port = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>8080<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    String host = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"127.0.0.1"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span> EchoClient().connect(port, host);
}

}
`<span class="tag">&lt;/<span class="title">pre</span>&gt;</span>

**客户端handler**

<span class="tag">&lt;<span class="title">pre</span>&gt;</span>`<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-class"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>class<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>EchoClientHandler<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>extends<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>ChannelHandlerAdapter<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>int<span class="tag">&lt;/<span class="title">span</span>&gt;</span> counter = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;
<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>static<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>final<span class="tag">&lt;/<span class="title">span</span>&gt;</span> String ECHO_REQ = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"Hi, krisjin. Welcome to Netty.$_"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>;

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>EchoClientHandler<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>()<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>channelActive<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(ChannelHandlerContext ctx)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>for<span class="tag">&lt;/<span class="title">span</span>&gt;</span> (<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>int<span class="tag">&lt;/<span class="title">span</span>&gt;</span> i = <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">span</span>&gt;</span>; i <span class="tag">&lt; &lt;<span class="attribute">span</span> <span class="attribute">class</span>=<span class="value">"hljs-number"</span>&gt;</span>10<span class="tag">&lt;/<span class="title">span</span>&gt;</span>; i++) {
        ByteBuf write = Unpooled.copiedBuffer(ECHO_REQ.getBytes());

        ctx.writeAndFlush(write);

    }
}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>channelRead<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(ChannelHandlerContext ctx, Object msg)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{

    System.out.println(<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"This is "<span class="tag">&lt;/<span class="title">span</span>&gt;</span> + ++counter + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"times recevie server : ["<span class="tag">&lt;/<span class="title">span</span>&gt;</span> + msg + <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-string"</span>&gt;</span>"]"<span class="tag">&lt;/<span class="title">span</span>&gt;</span>);

}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>channelReadComplete<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(ChannelHandlerContext ctx)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>throws<span class="tag">&lt;/<span class="title">span</span>&gt;</span> Exception <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
    ctx.flush();
}

<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-function"</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>public<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-keyword"</span>&gt;</span>void<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-title"</span>&gt;</span>exceptionCaught<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"hljs-params"</span>&gt;</span>(ChannelHandlerContext ctx, Throwable cause)<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;/<span class="title">span</span>&gt;</span>{
    cause.printStackTrace();
    ctx.close();
}
}</span>
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-13T05:35:46.000Z"><a href="/2015/02/13/netty-serializable-sample/">2月 13 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/13/netty-serializable-sample/">netty序列化实现</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="Java序列化">Java序列化</h3>
<p>jdk本身提供了序列化的实现，需要序列化的类要实现Serializable接口。<br>序列化的目的主要有网络传输和对象持久化，网络传输应用到远程系统之间的调用。持久化在ORM<br>中使用的较多。java序列化不支持多种语言的实现，假如A系统是用java 序列化请求到B系统，而B系统是用C++实现，在这种情况下Java序列化并不是很适用，很多成熟的远程调用框架也没有采用java 自带的序列化,java的序列化性能也很低<br>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2015/02/13/netty-serializable-sample/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-12T03:24:00.000Z"><a href="/2015/02/12/netty-fixed-length-decoder/">2月 12 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/12/netty-fixed-length-decoder/">netty定长消息解码</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="FixedLengthFrameDecoder使用">FixedLengthFrameDecoder使用</h3>
<p>FixedLengthFrameDecoder是netty提供的固定长度解码器，它能够按照指定的长度对消息进行解码，开发者不需要考虑TCP的粘包拆包问题，非常使用。下面通过一个实例来具体了解一下：</p>
<p>1、<strong>服务端:</strong><br>在服务端的ChannelPipeline中新增FixedLengthFrameDecoder，消息截取长度自定义。<br>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2015/02/12/netty-fixed-length-decoder/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-11T09:13:41.000Z"><a href="/2015/02/11/thread-tweleve-pattern/">2月 11 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/11/thread-tweleve-pattern/">java多线程12种设计模式记录</a></h1>
  

    </header>
    <div class="entry">
      
        <p>以下是java多线程编程中常见的设计模式，在网上找到在此保存，以供以后慢慢研究。</p>
<ol>
<li><p>Single Threaded Execution Pattern(单线程执行模式)</p>
</li>
<li><p>Immutable Pattern(不可变模式)</p>
</li>
<li><p>Guarded Suspension Pattern(防卫暂停模式)</p>
</li>
<li><p>Balking Pattern(止步模式，阻行模式)
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2015/02/11/thread-tweleve-pattern/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-10T08:56:24.000Z"><a href="/2015/02/10/netty-stick-principle/">2月 10 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/10/netty-stick-principle/">LineBasedFrameDecoder和StringDecoder的原理分析</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="LineBasedFrameDecoder详解">LineBasedFrameDecoder详解</h3>
<p>LineBasedFrameDecoder的工作原理是依次遍历ByteBuf中的可读字节，判断是否有“\n”或者“\r\n”，如果有就以此为结束为止，从可读索引到结束位置区间的字节组成了一行。它是以换行符为结束标志的解码器，支持携带结束符或者不携带结束符两种解码方式，同时支持单行的最大长度。如果连续读取到最大长度后仍然没有发现换行符，就回抛出异常，同时忽略掉之前读到的异常码流。<br>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2015/02/10/netty-stick-principle/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-10T03:36:43.000Z"><a href="/2015/02/10/tcp-stick-problem-understand/">2月 10 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/10/tcp-stick-problem-understand/">理解TCP粘包问题之网络编程总结</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="协议简述">协议简述</h3>
<ol>
<li><strong>TCP/IP协议</strong> ：链路层，网络层，传输层，应用层。 　　</li>
<li>以太网（Ethernet）的数据帧在链路层 　　</li>
<li>IP包在网络层 　　</li>
<li>TCP或UDP包在传输层 　　</li>
<li>TCP或UDP中的数据（Data)在应用层,它们的关系是 数据帧｛IP包｛TCP或UDP｛Data｝｝｝  
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2015/02/10/tcp-stick-problem-understand/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-09T07:23:20.000Z"><a href="/2015/02/09/tcp-stick-package-unpacking/">2月 9 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/09/tcp-stick-package-unpacking/">tcp粘包拆包实例</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="1-TCP粘包/拆包">1.TCP粘包/拆包</h3>
<p>TCP是个”流”协议，所谓流，就是没有界限的一串数据。大家可以想想河里的水，是连成一片的，其间并没有分界线。TCP底层并不了解上层业务数据的具体含义，它会根据TCP缓冲区的实际情况进行包的划分，所以在业务上认为，一个完整的包可能被TCP拆分成多个包进行发送，也有可能把多个小的包封装成一个大的数据包发送，这就是所谓的TCP粘包和拆包问题。<br>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2015/02/09/tcp-stick-package-unpacking/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-06T08:55:50.000Z"><a href="/2015/02/06/netty-start-sample/">2月 6 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/06/netty-start-sample/">netty入门实例</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="netty介绍">netty介绍</h2>
<p>Netty is a NIO client server framework which enables quick and easy development of network applications such as protocol servers and clients. It greatly simplifies and streamlines network programming such as TCP and UDP socket server.</p>
<p>‘Quick and easy’ doesn’t mean that a resulting application will suffer from a maintainability or a performance issue. Netty has been designed carefully with the experiences earned from the implementation of a lot of protocols such as FTP, SMTP, HTTP, and various binary and text-based legacy protocols. As a result, Netty has succeeded to find a way to achieve ease of development, performance, stability, and flexibility without a compromise.</p>

      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2015/02/06/netty-start-sample/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-05T02:46:02.000Z"><a href="/2015/02/05/mybatis-proxy-pattern/">2月 5 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/05/mybatis-proxy-pattern/">mybatis映射配置代理模式的使用</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="1-mybatis映射简述">1.mybatis映射简述</h2>
<p>在使用mybatis过程中，一直有一个疑惑，在定义的DAO层接口并没有实现，接口类是怎么与映射文件进行连接的。接口名称与映射文件必须保持一直，为什么一定要这样做呢。一个接口类怎么做到与映射文件进行连接并执行sql，查看源代码中发现使用jdk动态代理，下面以一个简单的实例来说明一下流程。<br>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2015/02/05/mybatis-proxy-pattern/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:krisjin.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/mybatis/">mybatis</a><small>1</small></li>
  
    <li><a href="/categories/netty/">netty</a><small>5</small></li>
  
    <li><a href="/categories/tcp/">tcp</a><small>1</small></li>
  
    <li><a href="/categories/thread/">thread</a><small>1</small></li>
  
    <li><a href="/categories/线程/">线程</a><small>0</small></li>
  
  </ul>
</div>


  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=1683020051&verifier=2d7c2166&colors=99d9ea,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><section>
Theme of <a href="https://github.com/krisjin">Light</a>, Improved from <a href="https://github.com/hexojs/hexo-theme-light">Light</a>, by <a href="/">krisjin</a> 
</section>
<div class="clearfix"></div>
</footer>
  <script src="//libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>


<a href="https://github.com/krisjin" target="_blank"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_white_ffffff.png" alt="Fork me on GitHub"></a>
